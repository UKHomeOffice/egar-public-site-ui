{% extends "base-template.njk" %}

{% import "common/templates/includes/macros.njk" as m %}

{% block pageTitle %}
  {{__('error_prefix') if errors}} Create GAR | Passenger Check
{% endblock %}

{% set active = '/home' %}

{% block header %}
  {% include "header-user.njk" %}
{% endblock %}

{% block beforeContent %}
  {% include "phase.njk" %}
{% endblock %}

{% block content %}
  <link rel="stylesheet" href="/stylesheets/amg.css"/> 
  <div class="govuk-grid-row" id="checkinpage" >
    {% if resubmitted === 'no' and numberOf0TResponseCodes > 0 and durationInDeparture > 125  %}
    <div class="govuk-grid-column-full">
       <div class="custom-govuk-notification-banner" role="region"
        aria-labelledby="govuk-notification-banner-title"
        data-module="custom-govuk-notification-banner">
        <div class="govuk-notification-banner__header">
            <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
            Important
            </h2>
        </div>
        <div class="govuk-notification-banner__content">
            <p class="govuk-body">
             <strong>{{numberOf0TResponseCodes}} {% if numberOf0TResonseCodes == 1 %} passenger {% else %} passengers {% endif %} have a 'system time out' status.</strong>
             This means we were unable to check their permission to travel status.
            </p>
            <p class="govuk-body">
              You should <a href="#" id="resubmitZeroT" class="govuk-link resubmitZeroT">resubmit permission to travel checks</a> for them if your expected time of departure is more than 2 hours 5 minutes in the future, otherwise you can continue to board the passenger.
            </p>
        </div>
      </div>
      {% endif %}
      <span class="govuk-caption-xl">{{__('section_count', 9, 9)}}</span>
      <h1 class="govuk-heading-xl">{{__('title_submit_gar_amg')}}</h1>
     
      <div>
       <p class="govuk-body">Passenger details have been sent for permission to travel checks.</p>
       <p class="govuk-body">{{__('guidance') | safe}}</p>
      </div>
      <div id="pane">
        {% include "app/garfile/amg/checkin/pane.njk" %}
      </div>
    </div>
  </div>
  <form id="reSubmitGarForm" action="/garfile/review" method="post">
    <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
    <input type="hidden" name="resubmitFor0T" value="resubmitZeroT" />
  </form>

  <script>
   $(function () {
      window.myinterval = setInterval(function () {
        const permissionDetails = () => Array.from(document.getElementsByClassName('permission-details'));
        const permissionDetailsState = permissionDetails().map(el => el.open);
        
        $.get('/garfile/amg/checkin?template=pane', null, function (data) {
          const html = $(data);
          if (!html.find('#spinner').length) {
            clearInterval(window.myinterval);
          }

          $('#pane').html($(data));

          permissionDetails().forEach((el, index) => {
            
            el.toggleAttribute("open", permissionDetailsState[index])
          })
        });

      }, 3000);
    });
</script>
  <script type="text/javascript" src="/javascripts/resubmitGar.js"></script>
{% endblock content %}
{% extends "base-template.njk" %}

{% import "common/templates/includes/macros.njk" as m %}

{% block pageTitle %}
  {{__('error_prefix') if errors}} Create GAR | Review
{% endblock %}

{% set active = '/home' %}

{% block header %}
  {% include "header-user.njk" %}
{% endblock %}

{% block beforeContent %}
  {% include "phase.njk" %}
  <a href="/garfile/supportingdocuments" class="govuk-back-link">{{__('nav_back')}}</a>
{% endblock %}


{% block content %}
  {# <pre>{{garfile | dump(2)}}</pre> #}
  {# <pre>{{isJourneyUkInbound | dump(2)}}</pre> #}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-xl">{{__('section_count', 8, 9)}}</span>
      <h1 class="govuk-heading-xl">{{__('title_review_gar')}}</h1>

      {% if errors %}
        {% include "common/templates/includes/errors.njk" %}
      {% endif %}

      {% include "check-your-answers.njk" %}

      {% if isJourneyUkInbound%}
        <form id="submitGarForm" action="/garfile/review" method="post" class="form">
          <h2 class="govuk-heading-m">{{__('heading_submit_gar')}}</h2>
          <input id='review-submit' type="submit" class="govuk-button" value="{{__('review_gar_submit_amg')}}">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        </form>
      {% else %}
        <form id="submitGarForm" action="/garfile/review" method="post" class="form">
          <h2 class="govuk-heading-m">{{__('heading_submit_gar')}}</h2>
          <input id='review-submit' type="submit" class="govuk-button" value="{{__('review_gar_submit')}}">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        </form>
      {% endif %}
      <form id="cancel-form" action="/garfile/view" method="post" role="form">
        <button type="submit" id="review-exit" class="govuk-button govuk-button--secondary" data-module="govuk-button">
          {{__('review_gar_exit')}}
        </button>
        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
      </form>
    </div>
  </div>

    <dialog id="confirmWarnedDepartureDialog">
    <p class="govuk-error-message">
      {{ __('field_departure_date_2_hours_prior') }}
    </p>
    <p>
      sGAR will allow you to submit the GAR, but it is not recommended.
    </p>
    <form method="dialog">
      <button type="submit" class="govuk-button" data-module="govuk-button">
        Close and fix departure date
      </button>
    </form>
    <button id="continueWithWarnedDate" type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
      Continue with warned departure date
    </button>
  </dialog>

  <script type="text/javascript" src="/utils/validator.js"></script>
  <script type="text/javascript">
    const twoHourWarningText = document.getElementById("twoHourWarningText");

    const departureDate = document.getElementById("departureDate");
    const departureTime = document.getElementById("departureTime");

    const submitGarForm = document.getElementById("submitGarForm");
    const continueWithWarnedDate = document.getElementById('continueWithWarnedDate');
    console.log({ 
      departureDate: departureDate.value, 
      departureTime: departureTime.value
    })
    
    setTimeout(() => {
      twoHourWarningText.hidden = isTwoHoursPriorDeparture({ 
        departureDate: departureDate.value, 
        departureTime: departureTime.value
      });
    }, 500)

    submitGarForm.addEventListener("submit", (e) => {
      if (!isTwoHoursPriorDeparture({ 
        departureDate: departureDate.value, 
        departureTime: departureTime.value
      })) {
        e.preventDefault();
        document.getElementById("confirmWarnedDepartureDialog").showModal();
      }
    });

    continueWithWarnedDate.addEventListener("click", (e) => submitGarForm.submit());

  </script>
{% endblock %}


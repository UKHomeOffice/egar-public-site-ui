{% extends "base-template.njk" %}

{% import "common/templates/includes/macros.njk" as m %}

{% block pageTitle %}
  {{__('error_prefix') if errors}} Create GAR | Review
{% endblock %}

{% set active = '/home' %}

{% block header %}
  {% include "header-user.njk" %}
{% endblock %}

{% block beforeContent %}
  {% include "phase.njk" %}
  <a href="/garfile/supportingdocuments" class="govuk-back-link">{{__('nav_back')}}</a>
{% endblock %}


{% block content %}
  {# <pre>{{garfile | dump(2)}}</pre> #}
  {# <pre>{{isJourneyUkInbound | dump(2)}}</pre> #}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-xl">{{__('section_count', 8, 9)}}</span>
      <h1 class="govuk-heading-xl">{{__('title_review_gar')}}</h1>

      {% if errors %}
        {% include "common/templates/includes/errors.njk" %}
      {% endif %}

      {% include "check-your-answers.njk" %}

      {% if isJourneyUkInbound%}
        <form id="submitGarForm" action="/garfile/review" method="post" class="form">
          <h2 class="govuk-heading-m">{{__('heading_submit_gar')}}</h2>
          <input id='review-submit' type="submit" class="govuk-button" value="{{__('review_gar_submit_amg')}}">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        </form>
      {% else %}
        <form id="submitGarForm" action="/garfile/review" method="post" class="form">
          <h2 class="govuk-heading-m">{{__('heading_submit_gar')}}</h2>
          <input id='review-submit' type="submit" class="govuk-button" value="{{__('review_gar_submit')}}">
          <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        </form>
      {% endif %}
      <form id="cancel-form" action="/garfile/view" method="post" role="form">
        <button type="submit" id="review-exit" class="govuk-button govuk-button--secondary" data-module="govuk-button">
          {{__('review_gar_exit')}}
        </button>
        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
      </form>
    </div>
  </div>

  {{ m.departure_warning_dialog(__) }}

  <script type="text/javascript" src="/utils/validator.js"></script>
  <script type="text/javascript">
    const submitGarForm = document.getElementById("submitGarForm");
    const confirmWarnedDepartureDialog = document.getElementById("confirmWarnedDepartureDialog")
    const continueWithWarnedDate = document.getElementById('continueWithWarnedDate');

    const twoHourWarningTexts = Array.from(document.getElementsByClassName("twoHourWarningText"));
    const fortyEightHourWarningTexts = Array.from(document.getElementsByClassName("fortyEightHourWarningText"));

    const departureDate = document.getElementById("departureDate");
    const departureTimeText = document.getElementById("departureTime");

    let departureFormSubmitter = undefined;

    dialogPolyfill.registerDialog(confirmWarnedDepartureDialog);

    const fullDepartureDate = new Date(Date.parse(`${departureDate.textContent}T${departureTime.textContent}`));

    function showDepartureDateWarningMessages(providedDate) {
      twoHourWarningTexts.forEach($element => $element.hidden = isTwoHoursPriorDeparture(providedDate));
      fortyEightHourWarningTexts.forEach($element => $element.hidden = dateNotMoreThanTwoDaysInFuture(providedDate));
    }

    setTimeout(() => {
      if ([departureDate.textContent, departureTime.textContent].includes('')) {
        return false;
      }

      showDepartureDateWarningMessages(fullDepartureDate);
    }, 500)


    submitGarForm.addEventListener("submit", (e) => {
      if ([departureDate.textContent, departureTime.textContent].includes('')) {
        return true;
      }

      if (departureFormSubmitter) {
        return true;
      }
      
      if (isTwoHoursPriorDeparture(fullDepartureDate) && dateNotMoreThanTwoDaysInFuture(fullDepartureDate)) {
        return true;
      }

      e.preventDefault();
      departureFormSubmitter = e.submitter;
      showDepartureDateWarningMessages(fullDepartureDate);
      confirmWarnedDepartureDialog.showModal();
      
    });

    confirmWarnedDepartureDialog.addEventListener("close", (e) => {
      departureFormSubmitter = undefined;
    });
    continueWithWarnedDate.addEventListener("click", (e) => {
      submitGarForm.requestSubmit(departureFormSubmitter);
    });
  </script>
{% endblock %}

